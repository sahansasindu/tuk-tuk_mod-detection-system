{% extends "base.html" %}
{% block content %}

<style>
  body { background-color: #f4f7fb; }
  .card {
    border-radius: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  img, video {
    max-width: 100%;
    border-radius: 10px;
    margin-top: 15px;
  }
  pre {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    white-space: pre-wrap;
    font-size: 0.95rem;
    text-align: left;
  }
  #cameraSection { display: none; }
  #closeDetectionBtn { display: none; }
</style>

<div class="container p-3 text-center">
  <div class="card p-4">
    <h2 class="mb-3 text-primary">Illegal Vehicle Modification Detector</h2>

    <!-- Upload Form -->
    <div class="mb-3 text-start">
      <label class="form-label fw-bold">Upload Vehicle Image</label>
      <input type="file" id="imageInput" class="form-control" accept="image/*">
      <small class="text-muted">Supported formats: JPG, PNG (clear side/front view recommended)</small>
    </div>

    <!-- Camera Controls -->
    <button class="btn btn-outline-primary mb-3" id="openCameraBtn">
      üì∑ Open Camera
    </button>

    <!-- Detect Button Below -->
    <button class="btn btn-success w-100 mb-3" id="uploadDetectBtn">
      ‚úÖ Detect Uploaded Image
    </button>

    

    <div id="cameraSection">
      <video id="camera" autoplay playsinline class="mt-2"></video>
      <canvas id="snapshot" style="display:none;"></canvas>

      <div class="mt-3">
        <button class="btn btn-secondary" id="captureBtn">üì∏ Capture Photo</button>
        <button class="btn btn-success" id="detectFromCamera" style="display:none;">
          üîç Detect Captured Image
        </button>
        <button class="btn btn-outline-danger" id="closeCameraBtn">‚ùå Close Camera</button>
      </div>
    </div>

    <!-- Result -->
    <div id="result" class="mt-3"></div>

    <!-- Close Detection Button -->
    <button class="btn btn-outline-secondary w-100 mt-3" id="closeDetectionBtn">
      üßπ Clear Result
    </button>
  </div>
</div>

<script>
  const fileInput = document.getElementById("imageInput");
  const uploadDetectBtn = document.getElementById("uploadDetectBtn");
  const resultDiv = document.getElementById("result");
  const closeDetectionBtn = document.getElementById("closeDetectionBtn");

  const camera = document.getElementById("camera");
  const canvas = document.getElementById("snapshot");
  const openCameraBtn = document.getElementById("openCameraBtn");
  const closeCameraBtn = document.getElementById("closeCameraBtn");
  const captureBtn = document.getElementById("captureBtn");
  const detectFromCamera = document.getElementById("detectFromCamera");
  const cameraSection = document.getElementById("cameraSection");

  let stream = null;

  // -----------------------------
  // Detect uploaded image
  // -----------------------------
  uploadDetectBtn.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if (!file) { alert("Please upload an image."); return; }

    resultDiv.innerHTML = "<div class='text-muted'>üîÑ Processing...</div>";

    const formData = new FormData();
    formData.append("image", file);

    try {
      const res = await fetch("/detect_illegal_modification", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      showResult(data);
    } catch (err) {
      console.error(err);
      resultDiv.innerHTML = "<p class='text-danger'>‚ùå Error processing image.</p>";
    }
  });

  // -----------------------------
  // Open Camera
  // -----------------------------
  openCameraBtn.addEventListener("click", async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      camera.srcObject = stream;
      cameraSection.style.display = "block";
      openCameraBtn.style.display = "none";
    } catch (err) {
      alert("Camera access denied or unavailable.");
      console.error(err);
    }
  });

  // -----------------------------
  // Close Camera
  // -----------------------------
  closeCameraBtn.addEventListener("click", () => {
    if (stream) stream.getTracks().forEach(track => track.stop());
    cameraSection.style.display = "none";
    openCameraBtn.style.display = "inline-block";
  });

  // -----------------------------
  // Capture Photo
  // -----------------------------
  captureBtn.addEventListener("click", () => {
    const ctx = canvas.getContext("2d");
    canvas.width = camera.videoWidth;
    canvas.height = camera.videoHeight;
    ctx.drawImage(camera, 0, 0);

    const preview = canvas.toDataURL("image/jpeg");
    resultDiv.innerHTML = `<img src="${preview}" class="img-fluid rounded mb-3">`;

    detectFromCamera.style.display = "inline-block";
    closeDetectionBtn.style.display = "inline-block";
  });

  // -----------------------------
  // Detect Captured Image
  // -----------------------------
  detectFromCamera.addEventListener("click", async () => {
    resultDiv.innerHTML = "<div class='text-muted'>üîÑ Processing...</div>";

    const blob = await new Promise(resolve =>
      canvas.toBlob(resolve, "image/jpeg")
    );

    const formData = new FormData();
    formData.append("image", blob, "captured.jpg");

    const res = await fetch("/detect_illegal_modification", {
      method: "POST",
      body: formData
    });

    const data = await res.json();
    showResult(data);
  });

  // -----------------------------
  // Show Result
  // -----------------------------
  function showResult(data) {
    closeDetectionBtn.style.display = "block";

    if (data.error) {
      resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
      return;
    }

    const alertType = data.illegal_detected ? "danger" : "success";

    resultDiv.innerHTML = `
      <div class="alert alert-${alertType}">
        <b>${data.illegal_detected ? "‚ö†Ô∏è Illegal Modification Detected!" : "‚úÖ No Illegal Modification Detected"}</b>
      </div>

      <p><b>Detected Classes:</b> ${data.detected_classes.join(", ") || "None"}</p>

      <img src="${data.result_image}" alt="Detection Result" class="img-fluid rounded mb-3">

      <pre>${data.violation_message}</pre>
    `;
  }

  // -----------------------------
  // Clear Result
  // -----------------------------
  closeDetectionBtn.addEventListener("click", () => {
    resultDiv.innerHTML = "";
    fileInput.value = "";
    detectFromCamera.style.display = "none";
    closeDetectionBtn.style.display = "none";
  });
</script>

{% endblock %}
